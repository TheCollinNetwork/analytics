import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import session from 'express-session';
import OAuth from 'oauth';

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3001;

// Simple in-memory token store (use Redis in production)
const tokenStore = new Map();

console.log('ğŸ’¾ Using in-memory token store');

// Enhanced CORS for Codespaces
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

app.use(express.json());

// Session middleware - CRITICAL for OAuth
app.use(session({
  secret: process.env.SESSION_SECRET || 'change-this-secret',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: false, // Set true only if using HTTPS everywhere
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000, // 24 hours
    sameSite: 'lax'
  }
}));

console.log('ğŸ”‘ Twitter API Key:', process.env.TWITTER_API_KEY ? 'Loaded âœ“' : 'MISSING âœ—');
console.log('ğŸ”‘ Twitter API Secret:', process.env.TWITTER_API_SECRET ? 'Loaded âœ“' : 'MISSING âœ—');
console.log('ğŸ”— Callback URL:', `${process.env.BACKEND_URL}/api/auth/callback`);

// Initialize OAuth
const oauth = new OAuth.OAuth(
  'https://api.twitter.com/oauth/request_token',
  'https://api.twitter.com/oauth/access_token',
  process.env.TWITTER_API_KEY,
  process.env.TWITTER_API_SECRET,
  '1.0A',
  `${process.env.BACKEND_URL}/api/auth/callback`,
  'HMAC-SHA1'
);

// Root endpoint
app.get('/', (req, res) => {
  res.json({ 
    message: 'Twitter Analytics Backend API',
    status: 'running',
    oauth_configured: !!(process.env.TWITTER_API_KEY && process.env.TWITTER_API_SECRET),
    endpoints: {
      health: '/api/health',
      auth_start: '/api/auth/twitter',
      auth_callback: '/api/auth/callback',
      user_data: '/api/twitter/user (POST)',
      user_tweets: '/api/twitter/tweets (POST)'
    }
  });
});

app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'Server is running',
    oauth_ready: !!(process.env.TWITTER_API_KEY && process.env.TWITTER_API_SECRET)
  });
});

// Step 1: Start OAuth flow
app.get('/api/auth/twitter', (req, res) => {
  console.log('\nğŸ” === Starting OAuth Flow ===');
  
  if (!process.env.TWITTER_API_KEY || !process.env.TWITTER_API_SECRET) {
    console.error('âŒ Missing Twitter credentials!');
    return res.status(500).json({ 
      error: 'Server not configured. Missing Twitter API credentials in .env file.' 
    });
  }
  
  oauth.getOAuthRequestToken((error, oauthToken, oauthTokenSecret, results) => {
    if (error) {
      console.error('âŒ Error getting request token:', error);
      console.error('   Status Code:', error.statusCode);
      console.error('   Data:', error.data);
      return res.status(500).json({ 
        error: 'Failed to get OAuth request token',
        details: error.data || error.message 
      });
    }
    
    // Store token secret in memory store
    tokenStore.set(oauthToken, {
      tokenSecret: oauthTokenSecret,
      timestamp: Date.now()
    });
    
    console.log('âœ… Request token obtained:', oauthToken);
    console.log('ğŸ’¾ Token secret stored in memory');
    
    const authUrl = `https://api.twitter.com/oauth/authorize?oauth_token=${oauthToken}`;
    console.log('ğŸ“¤ Sending auth URL to client');
    
    res.json({ authUrl });
  });
});

// Step 2: Handle callback from Twitter
app.get('/api/auth/callback', (req, res) => {
  console.log('\nğŸ“¥ === OAuth Callback Received ===');
  console.log('ğŸ“‹ Query params:', req.query);
  
  const { oauth_token, oauth_verifier, denied } = req.query;
  
  // Check if user denied
  if (denied) {
    console.log('âš ï¸  User denied authorization');
    return res.redirect(`${process.env.FRONTEND_URL}?auth=denied`);
  }
  
  // Validate parameters
  if (!oauth_token || !oauth_verifier) {
    console.error('âŒ Missing OAuth parameters');
    return res.redirect(`${process.env.FRONTEND_URL}?auth=error&message=missing_params`);
  }
  
  // Retrieve token secret from memory store
  const tokenData = tokenStore.get(oauth_token);
  
  if (!tokenData) {
    console.error('âŒ Token not found in store');
    console.log('   Available tokens:', Array.from(tokenStore.keys()));
    return res.redirect(`${process.env.FRONTEND_URL}?auth=error&message=token_not_found`);
  }
  
  const oauthTokenSecret = tokenData.tokenSecret;
  console.log('âœ… Token secret retrieved from memory');
  console.log('ğŸ”„ Exchanging request token for access token...');
  
  // Clean up the request token
  tokenStore.delete(oauth_token);
  
  // Exchange for access token
  oauth.getOAuthAccessToken(
    oauth_token,
    oauthTokenSecret,
    oauth_verifier,
    (error, accessToken, accessTokenSecret, results) => {
      if (error) {
        console.error('âŒ Error getting access token:', error);
        return res.redirect(`${process.env.FRONTEND_URL}?auth=error&message=token_exchange_failed`);
      }
      
      // Store access tokens with a unique session key
      const sessionKey = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      tokenStore.set(sessionKey, {
        accessToken,
        accessTokenSecret,
        userId: results.user_id,
        screenName: results.screen_name,
        timestamp: Date.now()
      });
      
      console.log('âœ… Access token obtained for user:', results.screen_name);
      console.log('ğŸ’¾ Access tokens stored with key:', sessionKey);
      console.log('ğŸ‰ OAuth flow complete!');
      
      // Redirect with session key
      res.redirect(`${process.env.FRONTEND_URL}?auth=success&session=${sessionKey}&user=${results.screen_name}`);
    }
  );
});

// Get user data using session key
app.post('/api/twitter/user', (req, res) => {
  console.log('\nğŸ“¥ === Fetching User Data ===');
  
  const { sessionKey } = req.body;
  
  if (!sessionKey) {
    console.error('âŒ No session key provided');
    return res.status(401).json({ error: 'Not authenticated. No session key provided.' });
  }
  
  const sessionData = tokenStore.get(sessionKey);
  
  if (!sessionData) {
    console.error('âŒ Invalid or expired session key');
    return res.status(401).json({ error: 'Session expired. Please login again.' });
  }
  
  const { accessToken, accessTokenSecret } = sessionData;
  console.log('ğŸ” Fetching user data from Twitter...');
  
  oauth.get(
    'https://api.twitter.com/1.1/account/verify_credentials.json',
    accessToken,
    accessTokenSecret,
    (error, data) => {
      if (error) {
        console.error('âŒ Error fetching user data:', error);
        return res.status(500).json({ error: 'Failed to fetch user data', details: error.data });
      }
      
      try {
        const userData = JSON.parse(data);
        console.log('âœ… User data fetched for:', userData.screen_name);
        
        res.json({
          data: {
            id: userData.id_str,
            username: userData.screen_name,
            name: userData.name,
            public_metrics: {
              followers_count: userData.followers_count,
              following_count: userData.friends_count,
              tweet_count: userData.statuses_count
            }
          }
        });
      } catch (parseError) {
        console.error('âŒ Error parsing user data:', parseError);
        res.status(500).json({ error: 'Failed to parse user data' });
      }
    }
  );
});

// Get user tweets using session key
app.post('/api/twitter/tweets', (req, res) => {
  console.log('\nğŸ“¥ === Fetching User Tweets ===');
  
  const { sessionKey, count = 100 } = req.body;
  
  if (!sessionKey) {
    console.error('âŒ No session key provided');
    return res.status(401).json({ error: 'Not authenticated. No session key provided.' });
  }
  
  const sessionData = tokenStore.get(sessionKey);
  
  if (!sessionData) {
    console.error('âŒ Invalid or expired session key');
    return res.status(401).json({ error: 'Session expired. Please login again.' });
  }
  
  const { accessToken, accessTokenSecret } = sessionData;
  console.log(`ğŸ” Fetching ${count} tweets from Twitter...`);
  
  oauth.get(
    `https://api.twitter.com/1.1/statuses/user_timeline.json?count=${count}&exclude_replies=false&include_rts=true`,
    accessToken,
    accessTokenSecret,
    (error, data) => {
      if (error) {
        console.error('âŒ Error fetching tweets:', error);
        return res.status(500).json({ error: 'Failed to fetch tweets', details: error.data });
      }
      
      try {
        const tweets = JSON.parse(data);
        console.log(`âœ… Fetched ${tweets.length} tweets`);
        
        const transformedTweets = tweets.map(tweet => ({
          id: tweet.id_str,
          text: tweet.text,
          created_at: new Date(tweet.created_at).toISOString(),
          public_metrics: {
            like_count: tweet.favorite_count || 0,
            retweet_count: tweet.retweet_count || 0,
            reply_count: 0
          },
          entities: {
            hashtags: tweet.entities?.hashtags || [],
            urls: tweet.entities?.urls || []
          },
          attachments: tweet.entities?.media ? { media_keys: ['media'] } : undefined
        }));
        
        res.json({ data: transformedTweets });
      } catch (parseError) {
        console.error('âŒ Error parsing tweets:', parseError);
        res.status(500).json({ error: 'Failed to parse tweets' });
      }
    }
  );
});

// Clean up old tokens every hour
setInterval(() => {
  const now = Date.now();
  const oneHour = 60 * 60 * 1000;
  
  for (const [key, value] of tokenStore.entries()) {
    if (now - value.timestamp > oneHour) {
      tokenStore.delete(key);
      console.log('ğŸ§¹ Cleaned up expired token:', key);
    }
  }
}, 60 * 60 * 1000);

// Logout endpoint
app.post('/api/auth/logout', (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      console.error('âŒ Error destroying session:', err);
      return res.status(500).json({ error: 'Logout failed' });
    }
    console.log('ğŸ‘‹ User logged out');
    res.json({ success: true });
  });
});

app.listen(PORT, () => {
  console.log('\nğŸš€ ===================================');
  console.log(`ğŸš€ Server running on port ${PORT}`);
  console.log(`ğŸ“ Backend: ${process.env.BACKEND_URL}`);
  console.log(`ğŸ“ Frontend: ${process.env.FRONTEND_URL}`);
  console.log('ğŸš€ ===================================\n');
});
